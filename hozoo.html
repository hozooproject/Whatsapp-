<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Room Chat</title>
    <style>
        :root {
            --bg: #0b141a;
            --card: #111b21;
            --text: #e9edef;
            --muted: #8696a0;
            --accent: #25D366;
            --accent-press: #1DB955;
            --divider: #233138;
            --error: #ff6b6b;
            --warning: #ffcc00;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .screen {
            display: none;
            height: 100%;
            flex-direction: column;
            background-color: var(--bg);
        }

        .screen.active {
            display: flex;
        }

        /* Welcome Screen */
        #welcome {
            padding: 2rem;
            text-align: center;
            justify-content: center;
            align-items: center;
        }

        .logo-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            background: radial-gradient(ellipse at center, #12242c 0%, #0c171c 60%, transparent 60%), 
                        conic-gradient(from 0deg, #1c4d3a, #1f6b4a, #1a5a41, #1c4d3a);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px #113026;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 18px;
            background-color: var(--card);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 24px rgba(0,0,0,.45);
        }

        .logo svg {
            width: 40px;
            height: 40px;
            fill: var(--accent);
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        p {
            color: var(--muted);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        a {
            color: #53d86a;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 28px;
            background-color: var(--accent);
            color: #082012;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(10, 233, 117, 0.15);
            transition: all 0.2s ease;
        }

        .btn:active {
            background-color: var(--accent-press);
            transform: translateY(1px);
        }

        /* Phone Verification Screen */
        .topbar {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background-color: var(--card);
            border-bottom: 1px solid var(--divider);
        }

        .back {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .back svg {
            width: 24px;
            height: 24px;
            stroke: var(--text);
        }

        .title {
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .content {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .hint {
            color: var(--muted);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .phone-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .phone-input select {
            flex: 0 0 100px;
            padding: 0.75rem;
            background-color: var(--card);
            color: var(--text);
            border: 1px solid var(--divider);
            border-radius: 8px;
            appearance: none;
        }

        .phone-input input {
            flex: 1;
            padding: 0.75rem;
            background-color: var(--card);
            color: var(--text);
            border: 1px solid var(--divider);
            border-radius: 8px;
        }

        .error {
            color: var(--error);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .error.show {
            display: block;
        }

        /* Profile Setup Screen */
        #profileSetup {
            padding: 1.5rem;
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--card);
            margin: 0 auto 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            border: 3px solid var(--accent);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-preview svg {
            width: 48px;
            height: 48px;
            stroke: var(--muted);
        }

        .upload-btn {
            display: block;
            width: fit-content;
            margin: 0 auto 1.5rem;
            padding: 0.5rem 1rem;
            background-color: var(--card);
            color: var(--text);
            border: 1px solid var(--divider);
            border-radius: 20px;
            cursor: pointer;
        }

        .name-input {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--card);
            color: var(--text);
            border: 1px solid var(--divider);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        /* Chat Room Screen */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

        .message.received {
            align-self: flex-start;
        }

        .message.sent {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 0.5rem;
            object-fit: cover;
        }

        .message-sender {
            font-weight: bold;
            font-size: 0.875rem;
        }

        .message-content {
            background-color: var(--card);
            border-radius: 18px;
            padding: 0.75rem 1rem;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background-color: var(--accent);
            color: #082012;
            border-radius: 18px 18px 4px 18px;
        }

        .message.received .message-content {
            border-radius: 18px 18px 18px 4px;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 0.25rem;
            text-align: right;
        }

        .input-area {
            display: flex;
            padding: 0.75rem;
            background-color: var(--card);
            border-top: 1px solid var(--divider);
        }

        .input-area input {
            flex: 1;
            padding: 0.75rem 1rem;
            background-color: var(--bg);
            color: var(--text);
            border: 1px solid var(--divider);
            border-radius: 20px;
            margin: 0 0.5rem;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .icon-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--text);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .modal h3 {
            margin-bottom: 1rem;
        }

        .modal .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
        }

        .media-options {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .media-options button {
            flex: 1;
            padding: 1rem;
            background-color: var(--bg);
            border: 1px solid var(--divider);
            border-radius: 8px;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .media-options button svg {
            width: 40px;
            height: 40px;
            margin-bottom: 0.5rem;
            stroke: var(--text);
        }

        .invite-link {
            display: flex;
            margin: 1rem 0;
        }

        .invite-link input {
            flex: 1;
            padding: 0.75rem;
            background-color: var(--bg);
            color: var(--text);
            border: 1px solid var(--divider);
            border-radius: 8px 0 0 8px;
            border-right: none;
        }

        .invite-link button {
            padding: 0 1rem;
            background-color: var(--accent);
            color: #082012;
            border: none;
            border-radius: 0 8px 8px 0;
            font-weight: bold;
            cursor: pointer;
        }

        .stats {
            margin-top: 1rem;
            text-align: center;
            color: var(--muted);
        }

        /* Admin controls */
        .admin-controls {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--divider);
        }

        .admin-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--warning);
        }

        .admin-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .admin-btn {
            flex: 1;
            padding: 0.5rem;
            background-color: var(--bg);
            border: 1px solid var(--divider);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .admin-btn.kick {
            background-color: rgba(255, 107, 107, 0.1);
            border-color: var(--error);
        }

        .admin-btn.ban {
            background-color: rgba(255, 107, 107, 0.2);
            border-color: var(--error);
        }

        .admin-btn.allow {
            background-color: rgba(37, 211, 102, 0.1);
            border-color: var(--accent);
        }

        /* Banned screen */
        #bannedScreen {
            padding: 2rem;
            text-align: center;
            justify-content: center;
            align-items: center;
        }

        .banned-icon {
            font-size: 4rem;
            color: var(--error);
            margin-bottom: 1rem;
        }

        .banned-message {
            margin-bottom: 1.5rem;
        }

        .banned-btn {
            background-color: var(--bg);
            border: 1px solid var(--divider);
            color: var(--text);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Screen 1: Welcome -->
        <section id="welcome" class="screen active">
            <div class="logo-circle">
                <div class="logo">
                    <svg viewBox="0 0 24 24"><path d="M20 3.5A10.5 10.5 0 1 1 9.2 22.8L4 24l1.3-5.1A10.5 10.5 0 0 1 20 3.5Zm-5.6 6.3c-.2-.6-.4-.6-.7-.6h-.6c-.2 0-.6.1-.9.4-.3.3-1.1 1-1.1 2.4s1.2 2.7 1.4 2.8c.2.3 2.2 3.5 5.3 4.8.7.3 1.3.2 1.8.1.6-.1 1.8-.8 2-1.5.2-.7.2-1.3.1-1.5-.1-.2-.2-.3-.4-.4l-1.9-.9c-.2-.1-.5-.2-.7.2-.2.4-.8 1-1 1.2-.2.2-.4.2-.7.1-.3-.1-1.1-.4-2.1-1.3-1-.9-1.3-1.7-1.5-2-.2-.3 0-.5.1-.6.1-.1.2-.3.3-.4.1-.1.1-.2.2-.3.1-.1.1-.3.1-.4 0-.2-.1-.4-.2-.6l-.9-2Z"/></svg>
                </div>
            </div>
            <h1>Selamat datang di WhatsApp Room</h1>
            <p>Baca <a href="#" id="privacyLink">Kebijakan Privasi</a> kami. Ketuk <strong>"Setuju dan lanjutkan"</strong> untuk menerima <a href="#" id="termsLink">Ketentuan Layanan</a>.</p>
            <button id="agreeBtn" class="btn">Setuju dan lanjutkan</button>
        </section>

        <!-- Screen 2: Phone Verification -->
        <section id="phone" class="screen">
            <div class="topbar">
                <button class="back" id="backBtn">
                    <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <div class="title">Verifikasi Nomor</div>
            </div>
            <div class="content">
                <p class="hint">Masukkan nomor telepon untuk verifikasi</p>
                <div class="phone-input">
                    <select id="countryCode">
                        <option value="+62" selected>Indonesia (+62)</option>
                        <option value="+60">Malaysia (+60)</option>
                        <option value="+65">Singapore (+65)</option>
                    </select>
                    <input type="tel" id="phoneNumber" placeholder="Nomor telepon">
                </div>
                <p id="errorMsg" class="error"></p>
                <button id="verifyBtn" class="btn">Verifikasi</button>
            </div>
        </section>

        <!-- Screen 3: Profile Setup -->
        <section id="profileSetup" class="screen">
            <div class="topbar">
                <button class="back" id="backBtn2">
                    <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <div class="title">Setup Profil</div>
            </div>
            <div class="content">
                <div class="profile-preview" id="profilePreview">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <button id="uploadBtn" class="upload-btn">Unggah Foto Profil</button>
                <input type="text" id="userName" class="name-input" placeholder="Nama Anda" maxlength="30">
                <button id="saveProfileBtn" class="btn">Simpan Profil</button>
            </div>
        </section>

        <!-- Screen 4: Chat Room -->
        <section id="chatRoom" class="screen">
            <div class="topbar">
                <div class="room-info">
                    <h2 id="roomName">Room Chat</h2>
                    <p id="memberCount">0 anggota</p>
                </div>
                <button id="inviteBtn" class="icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                </button>
                <button id="adminBtn" class="icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 15l8-8m0 0h-6m6 0v6"/><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/></svg>
                </button>
            </div>
            
            <div class="chat-container">
                <div id="messages" class="messages">
                    <!-- Pesan akan dimuat di sini -->
                </div>
                
                <div class="input-area">
                    <button id="attachBtn" class="icon-btn">
                        <svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
                    </button>
                    <input type="text" id="messageInput" placeholder="Ketik pesan...">
                    <button id="sendBtn" class="icon-btn">
                        <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    </button>
                </div>
            </div>
            
            <!-- Modal untuk mengirim media -->
            <div id="mediaModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h3>Kirim Media</h3>
                    <div class="media-options">
                        <button id="sendPhotoBtn">
                            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                            Foto
                        </button>
                        <button id="sendVideoBtn">
                            <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                            Video (max 1 menit)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Modal untuk invite -->
            <div id="inviteModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h3>Undang Anggota</h3>
                    <p>Bagikan link ini untuk mengundang orang ke room:</p>
                    <div class="invite-link">
                        <input type="text" id="roomLink" readonly>
                        <button id="copyLinkBtn">Salin</button>
                    </div>
                    <div class="stats">
                        <p>Anggota yang sudah bergabung: <span id="joinedCount">0</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Modal untuk admin controls -->
            <div id="adminModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h3>Admin Controls</h3>
                    <p>Kelola anggota room:</p>
                    
                    <div class="member-list" id="memberList">
                        <!-- Daftar anggota akan dimuat di sini -->
                    </div>
                    
                    <div class="admin-controls">
                        <div class="admin-title">Kontrol Room</div>
                        <div class="admin-buttons">
                            <button id="closeRoomBtn" class="admin-btn">Tutup Room</button>
                            <button id="clearChatBtn" class="admin-btn">Bersihkan Chat</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Screen 5: Banned Screen -->
        <section id="bannedScreen" class="screen">
            <div class="banned-icon">🚫</div>
            <h1>Anda Telah Dikeluarkan</h1>
            <p class="banned-message">Anda tidak dapat mengakses room ini karena telah dikeluarkan oleh admin.</p>
            <button id="rejoinBtn" class="btn banned-btn">Minta Izin Masuk Kembali</button>
            <button id="newRoomBtn" class="btn">Buat Room Baru</button>
        </section>
    </div>

    <script>
        // Inisialisasi variabel
        let currentUser = null;
        let currentRoom = null;
        let socket = null;
        let isAdmin = false;
        let bannedUsers = JSON.parse(localStorage.getItem('bannedUsers')) || {};

        // DOM Elements
        const welcomeScreen = document.getElementById('welcome');
        const phoneScreen = document.getElementById('phone');
        const profileScreen = document.getElementById('profileSetup');
        const chatScreen = document.getElementById('chatRoom');
        const bannedScreen = document.getElementById('bannedScreen');
        const agreeBtn = document.getElementById('agreeBtn');
        const backBtn = document.getElementById('backBtn');
        const backBtn2 = document.getElementById('backBtn2');
        const verifyBtn = document.getElementById('verifyBtn');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const errorMsg = document.getElementById('errorMsg');
        const uploadBtn = document.getElementById('uploadBtn');
        const profilePreview = document.getElementById('profilePreview');
        const userName = document.getElementById('userName');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const inviteBtn = document.getElementById('inviteBtn');
        const adminBtn = document.getElementById('adminBtn');
        const attachBtn = document.getElementById('attachBtn');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messages');
        const mediaModal = document.getElementById('mediaModal');
        const inviteModal = document.getElementById('inviteModal');
        const adminModal = document.getElementById('adminModal');
        const roomLinkInput = document.getElementById('roomLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const joinedCount = document.getElementById('joinedCount');
        const sendPhotoBtn = document.getElementById('sendPhotoBtn');
        const sendVideoBtn = document.getElementById('sendVideoBtn');
        const memberList = document.getElementById('memberList');
        const closeRoomBtn = document.getElementById('closeRoomBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const rejoinBtn = document.getElementById('rejoinBtn');
        const newRoomBtn = document.getElementById('newRoomBtn');
        const closeButtons = document.querySelectorAll('.close');

        // Fungsi untuk menampilkan screen tertentu
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        // Cek apakah user dibanned
        function checkIfBanned(phoneNumber) {
            return bannedUsers[phoneNumber] && bannedUsers[phoneNumber].banned;
        }

        // Event Listeners
        agreeBtn.addEventListener('click', () => {
            showScreen(phoneScreen);
        });

        backBtn.addEventListener('click', () => {
            showScreen(welcomeScreen);
        });

        backBtn2.addEventListener('click', () => {
            showScreen(phoneScreen);
        });

        verifyBtn.addEventListener('click', () => {
            const phoneNumber = phoneNumberInput.value.trim();
            
            if (!phoneNumber) {
                errorMsg.textContent = 'Nomor telepon harus diisi';
                errorMsg.classList.add('show');
                return;
            }
            
            if (!/^\d{8,15}$/.test(phoneNumber)) {
                errorMsg.textContent = 'Nomor telepon harus 8-15 digit angka';
                errorMsg.classList.add('show');
                return;
            }
            
            errorMsg.classList.remove('show');
            
            // Cek apakah user dibanned
            const fullPhoneNumber = `+62${phoneNumber}`;
            if (checkIfBanned(fullPhoneNumber)) {
                showScreen(bannedScreen);
                return;
            }
            
            // Simpan nomor telepon sementara
            currentUser = {
                phoneNumber: fullPhoneNumber,
                name: '',
                avatar: ''
            };
            
            showScreen(profileScreen);
        });

        // Upload foto profil
        uploadBtn.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validasi ukuran file (maksimal 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('Ukuran foto terlalu besar. Maksimal 2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    // Tampilkan preview
                    profilePreview.innerHTML = `<img src="${event.target.result}" alt="Foto Profil">`;
                    currentUser.avatar = event.target.result;
                };
                reader.readAsDataURL(file);
            };
            
            fileInput.click();
        });

        // Simpan profil
        saveProfileBtn.addEventListener('click', () => {
            const name = userName.value.trim();
            
            if (!name) {
                alert('Nama harus diisi');
                return;
            }
            
            if (name.length < 3) {
                alert('Nama terlalu pendek (minimal 3 karakter)');
                return;
            }
            
            // Update data user
            currentUser.name = name;
            
            // Jika tidak upload foto, gunakan avatar default
            if (!currentUser.avatar) {
                currentUser.avatar = generateDefaultAvatar(name);
            }
            
            // Buat room baru
            currentRoom = {
                id: generateRoomId(),
                name: 'Room Chat',
                members: [currentUser],
                link: `${window.location.origin}/join/${generateRoomId()}`
            };
            
            // Set sebagai admin
            isAdmin = true;
            
            // Connect ke WebSocket
            connectToChat();
            
            showScreen(chatScreen);
        });

        // Fungsi untuk generate avatar default berdasarkan inisial nama
        function generateDefaultAvatar(name) {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            // Warna background acak
            const colors = ['#FF5733', '#33FF57', '#3357FF', '#F333FF', '#33FFF3'];
            const bgColor = colors[Math.floor(Math.random() * colors.length)];
            
            // Gambar background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Gambar inisial
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Ambil inisial
            const initials = name.split(' ').map(part => part[0]).join('').toUpperCase().substring(0, 2);
            
            ctx.fillText(initials, canvas.width/2, canvas.height/2);
            
            return canvas.toDataURL();
        }

        // Fungsi untuk generate room ID
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 10);
        }

        // Fungsi untuk connect ke WebSocket
        function connectToChat() {
            // Simulasikan koneksi WebSocket
            console.log(`Connecting to room ${currentRoom.id} as ${currentUser.name}`);
            
            // Simulasi pesan
            setTimeout(() => {
                addMessage({
                    sender: 'System',
                    senderAvatar: '',
                    content: 'Anda telah bergabung ke room chat',
                    timestamp: new Date().toISOString(),
                    type: 'text'
                });
                
                // Jika admin, tampilkan pesan khusus
                if (isAdmin) {
                    addMessage({
                        sender: 'System',
                        senderAvatar: '',
                        content: 'Anda adalah admin room ini. Anda dapat mengelola anggota room.',
                        timestamp: new Date().toISOString(),
                        type: 'text'
                    });
                }
            }, 500);
        }

        // Fungsi untuk menambahkan pesan ke UI
        function addMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            
            if (message.sender === currentUser.phoneNumber || message.sender === currentUser.name) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }
            
            let contentHTML = '';
            
            if (message.type === 'text') {
                contentHTML = `<div class="message-content">${escapeHtml(message.content)}</div>`;
            } else if (message.type === 'image') {
                contentHTML = `
                    <div class="message-content">
                        <img src="${message.content}" alt="Gambar" style="max-width: 100%; border-radius: 8px;">
                    </div>
                `;
            } else if (message.type === 'video') {
                contentHTML = `
                    <div class="message-content">
                        <video controls style="max-width: 100%; border-radius: 8px;">
                            <source src="${message.content}" type="video/mp4">
                        </video>
                    </div>
                `;
            }
            
            const senderName = message.sender === currentUser.phoneNumber || message.sender === currentUser.name ? 'Anda' : message.sender;
            const senderAvatar = message.sender === currentUser.phoneNumber || message.sender === currentUser.name ? currentUser.avatar : message.senderAvatar;
            
            messageElement.innerHTML = `
                <div class="message-header">
                    ${senderAvatar ? `<img src="${senderAvatar}" class="message-avatar" alt="${senderName}">` : ''}
                    <span class="message-sender">${senderName}</span>
                </div>
                ${contentHTML}
                <div class="message-time">
                    ${formatTime(message.timestamp)}
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Fungsi untuk mengirim pesan
        function sendMessage() {
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            const message = {
                sender: currentUser.name,
                senderAvatar: currentUser.avatar,
                content: content,
                timestamp: new Date().toISOString(),
                type: 'text'
            };
            
            // Dalam implementasi nyata, kirim via WebSocket:
            // socket.send(JSON.stringify(message));
            
            addMessage(message);
            messageInput.value = '';
            
            // Simulasi balasan
            if (Math.random() > 0.7) {
                setTimeout(() => {
                    const botAvatar = generateDefaultAvatar('Bot');
                    const replies = [
                        'Hai!',
                        'Apa kabar?',
                        'Pesan kamu sudah diterima',
                        'Saya sedang sibuk',
                        'Nanti saya balas ya'
                    ];
                    
                    const replyMessage = {
                        sender: 'Bot',
                        senderAvatar: botAvatar,
                        content: replies[Math.floor(Math.random() * replies.length)],
                        timestamp: new Date().toISOString(),
                        type: 'text'
                    };
                    
                    addMessage(replyMessage);
                }, 1000 + Math.random() * 3000);
            }
        }

        // Event listener untuk mengirim pesan
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Fungsi untuk membuka modal
        function openModal(modal) {
            modal.classList.add('active');
            
            if (modal === inviteModal) {
                roomLinkInput.value = currentRoom.link;
                joinedCount.textContent = currentRoom.members.length;
            } else if (modal === adminModal) {
                updateMemberList();
            }
        }

        // Fungsi untuk update daftar member
        function updateMemberList() {
            memberList.innerHTML = '';
            
            // Simulasi daftar member
            const members = [
                { name: currentUser.name, phoneNumber: currentUser.phoneNumber, avatar: currentUser.avatar },
                { name: 'Anggota 1', phoneNumber: '+6281234567890', avatar: generateDefaultAvatar('Anggota 1') },
                { name: 'Anggota 2', phoneNumber: '+6289876543210', avatar: generateDefaultAvatar('Anggota 2') }
            ];
            
            members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                memberElement.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 8px; background-color: ${member.phoneNumber === currentUser.phoneNumber ? 'rgba(37, 211, 102, 0.1)' : 'transparent'};">
                        <img src="${member.avatar}" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 0.5rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${member.name}</div>
                            <div style="font-size: 0.75rem; color: var(--muted);">${member.phoneNumber}</div>
                        </div>
                        ${member.phoneNumber !== currentUser.phoneNumber ? `
                        <div class="admin-buttons">
                            <button class="admin-btn kick" data-phone="${member.phoneNumber}">Kick</button>
                            <button class="admin-btn ban" data-phone="${member.phoneNumber}">Ban</button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                memberList.appendChild(memberElement);
            });
            
            // Tambahkan event listener untuk tombol kick dan ban
            document.querySelectorAll('.admin-btn.kick').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const phoneNumber = e.target.dataset.phone;
                    kickUser(phoneNumber);
                });
            });
            
            document.querySelectorAll('.admin-btn.ban').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const phoneNumber = e.target.dataset.phone;
                    banUser(phoneNumber);
                });
            });
        }

        // Fungsi untuk kick user
        function kickUser(phoneNumber) {
            // Dalam implementasi nyata, kirim perintah ke server
            console.log(`Kicking user with phone number: ${phoneNumber}`);
            
            // Simulasi pesan sistem
            addMessage({
                sender: 'System',
                senderAvatar: '',
                content: `Anggota dengan nomor ${phoneNumber} telah dikeluarkan dari room`,
                timestamp: new Date().toISOString(),
                type: 'text'
            });
            
            alert(`User dengan nomor ${phoneNumber} telah dikick`);
        }

        // Fungsi untuk ban user
        function banUser(phoneNumber) {
            // Simpan ke localStorage
            bannedUsers[phoneNumber] = { banned: true, timestamp: new Date().toISOString() };
            localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
            
            // Dalam implementasi nyata, kirim perintah ke server
            console.log(`Banning user with phone number: ${phoneNumber}`);
            
            // Simulasi pesan sistem
            addMessage({
                sender: 'System',
                senderAvatar: '',
                content: `Anggota dengan nomor ${phoneNumber} telah diblokir dari room`,
                timestamp: new Date().toISOString(),
                type: 'text'
            });
            
            alert(`User dengan nomor ${phoneNumber} telah diban dan tidak bisa masuk kembali`);
        }

        // Fungsi untuk menutup modal
        function closeModal(modal) {
            modal.classList.remove('active');
        }

        // Event listeners untuk modal
        inviteBtn.addEventListener('click', () => openModal(inviteModal));
        attachBtn.addEventListener('click', () => openModal(mediaModal));
        adminBtn.addEventListener('click', () => {
            if (isAdmin) {
                openModal(adminModal);
            } else {
                alert('Hanya admin yang bisa mengakses fitur ini');
            }
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                closeModal(mediaModal);
                closeModal(inviteModal);
                closeModal(adminModal);
            });
        });

        // Event listener untuk copy link
        copyLinkBtn.addEventListener('click', () => {
            roomLinkInput.select();
            document.execCommand('copy');
            
            // Tampilkan feedback
            const originalText = copyLinkBtn.textContent;
            copyLinkBtn.textContent = 'Tersalin!';
            
            setTimeout(() => {
                copyLinkBtn.textContent = originalText;
            }, 2000);
        });

        // Event listeners untuk mengirim media
        sendPhotoBtn.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validasi ukuran file (maksimal 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Ukuran foto terlalu besar. Maksimal 5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const message = {
                        sender: currentUser.name,
                        senderAvatar: currentUser.avatar,
                        content: event.target.result,
                        timestamp: new Date().toISOString(),
                        type: 'image'
                    };
                    
                    addMessage(message);
                    closeModal(mediaModal);
                };
                reader.readAsDataURL(file);
            };
            
            fileInput.click();
        });

        sendVideoBtn.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'video/*';
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Batasi ukuran video (contoh: 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Video terlalu besar. Maksimal 10MB');
                    return;
                }
                
                // Batasi durasi video (contoh: 1 menit)
                // Note: Untuk validasi durasi sebenarnya perlu pemrosesan lebih lanjut
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const message = {
                        sender: currentUser.name,
                        senderAvatar: currentUser.avatar,
                        content: event.target.result,
                        timestamp: new Date().toISOString(),
                        type: 'video'
                    };
                    
                    addMessage(message);
                    closeModal(mediaModal);
                };
                reader.readAsDataURL(file);
            };
            
            fileInput.click();
        });

        // Event listener untuk tombol rejoin
        rejoinBtn.addEventListener('click', () => {
            // Dalam implementasi nyata, kirim permintaan ke admin
            alert('Permintaan untuk bergabung kembali telah dikirim ke admin');
            
            // Simulasi admin menerima permintaan
            setTimeout(() => {
                // Hapus dari daftar banned
                delete bannedUsers[currentUser.phoneNumber];
                localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                
                // Kembali ke screen phone
                showScreen(phoneScreen);
            }, 3000);
        });

        // Event listener untuk tombol new room
        newRoomBtn.addEventListener('click', () => {
            // Reset dan kembali ke awal
            currentUser = null;
            currentRoom = null;
            showScreen(welcomeScreen);
        });

        // Fungsi untuk tutup room
        closeRoomBtn.addEventListener('click', () => {
            if (confirm('Apakah Anda yakin ingin menutup room ini? Semua anggota akan dikeluarkan.')) {
                // Dalam implementasi nyata, kirim perintah ke server
                console.log('Closing room');
                
                // Simulasi pesan sistem
                addMessage({
                    sender: 'System',
                    senderAvatar: '',
                    content: 'Room ini telah ditutup oleh admin',
                    timestamp: new Date().toISOString(),
                    type: 'text'
                });
                
                // Redirect semua user ke banned screen
                showScreen(bannedScreen);
            }
        });

        // Fungsi untuk bersihkan chat
        clearChatBtn.addEventListener('click', () => {
            if (confirm('Apakah Anda yakin ingin menghapus semua pesan di room ini?')) {
                // Dalam implementasi nyata, kirim perintah ke server
                console.log('Clearing chat');
                
                // Kosongkan chat
                messagesContainer.innerHTML = '';
                
                // Tambahkan pesan sistem
                addMessage({
                    sender: 'System',
                    senderAvatar: '',
                    content: 'Admin telah membersihkan semua pesan dalam room ini',
                    timestamp: new Date().toISOString(),
                    type: 'text'
                });
            }
        });

        // Fungsi helper untuk escape HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Fungsi helper untuk format waktu
        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Simulasi WebSocket (untuk demo saja)
        setInterval(() => {
            if (currentRoom && Math.random() > 0.9) {
                const systemMessages = [
                    'Anggota baru telah bergabung',
                    'Server akan maintenance sebentar',
                    'Jangan lupa patuhi aturan grup'
                ];
                
                const message = {
                    sender: 'System',
                    senderAvatar: '',
                    content: systemMessages[Math.floor(Math.random() * systemMessages.length)],
                    timestamp: new Date().toISOString(),
                    type: 'text'
                };
                
                addMessage(message);
            }
        }, 30000);
    </script>
</body>
</html>
